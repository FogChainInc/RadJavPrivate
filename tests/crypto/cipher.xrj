var win = new RadJav.GUI.Window ("win", "Window Example");

// Stupid hack for now. Delete in the future. Should throw errors in HTML5.
win.create ().then (function (win2)
	{
	});

var capabilities = RadJav.Crypto.Cipher.getCapabilities();

if ( (typeof capabilities.cryptoLibs === "object") && (capabilities.cryptoLibs !== null) )
{
    RadJav.Console.println("Has Crypto Implementation: ");
    for (var cryptoLib in capabilities.cryptoLibs)
    {
	RadJav.Console.println(cryptoLib);
    }
}

// Go for OpenSSL
if ( (typeof capabilities.cryptoLibs.OpenSSL === "object") && (capabilities.cryptoLibs.OpenSSL !== null) )
{
    var cryptoLib = capabilities.cryptoLibs.OpenSSL;
    for (var idx in cryptoLib.cipherAlgorithms)
    {
	RadJav.Console.println(cryptoLib.cipherAlgorithms[idx].name + ":\t" + cryptoLib.cipherAlgorithms[idx].description);
    }

}


try
{
    RadJav.Console.println("##################### Test 1 ######################################");
    var cipher = new RadJav.Crypto.Cipher({cryptoLibrary: "OpenSSL", cipherAlgorithm: "blah", outputEncoding: "hex"});

    var cipherResult = cipher.cipherSync('asdfadfadsf');
    RadJav.Console.println("Cipher Algorithm: " + cipher.cipherAlgorithm);
    RadJav.Console.println("Cipher Result: " + cipherResult);
}
catch (error)
{
    RadJav.Console.println(error);
}

try {
    RadJav.Console.println("##################### Test 2 ######################################");
    var cipher = new RadJav.Crypto.Cipher({cryptoLibrary: "OpenSSL",
					   cipherAlgorithm: "aes-128-cbc",
					   outputEncoding: "base64"});

    var cipherResult = cipher.cipherSync('asdfadfadsf');
    RadJav.Console.println("Cipher Algorithm: " + cipher.cipherAlgorithm);
    RadJav.Console.println("Cipher Result: " + cipherResult + ", len: " );
}
catch (error)
{
    RadJav.Console.println(error);
}


try {
    RadJav.Console.println("##################### Test 3 ######################################");
    var cipher = new RadJav.Crypto.Cipher({cryptoLibrary: "OpenSSL",
					   cipherAlgorithm: "aes-128-cbc",
					   secret: "Beer",
					   outputEncoding: "base64"});

    var cipherResult = cipher.cipherSync('asdfadfadsf');
    RadJav.Console.println("Cipher Algorithm: " + cipher.cipherAlgorithm);
    RadJav.Console.println("Cipher Result: " + cipherResult);

    var decipher = new RadJav.Crypto.Decipher({cryptoLibrary: "OpenSSL",
					       cipherAlgorithm: "aes-128-cbc",
					       secret: "Beer",
					       inputEncoding: "base64"
					      });

    var decipherResult = decipher.decipherSync(cipherResult);
    RadJav.Console.println("Decipher Result: " + decipherResult);
}
catch (error)
{
    RadJav.Console.println(error);
}

try {
    RadJav.Console.println("##################### Test 4 ######################################");
    var cipher = new RadJav.Crypto.Cipher({cryptoLibrary: "OpenSSL",
					    cipherAlgorithm: "aes-128-cbc",
					    secret: "Beer",
					   });
    var cipherResult = cipher.cipherSync('asdfadfadsf');
    var cipherData = new Uint8Array(cipherResult);
    RadJav.Console.println("Cipher Algorithm: " + cipher.cipherAlgorithm);
    RadJav.Console.println("Cipher Result: " + hexdump(cipherResult) + hexdump(cipherResult) +
			   ", " + buf2hex(cipherResult) +
			   ", len:" + cipherData.length);


    var decipher = new RadJav.Crypto.Decipher({cryptoLibrary: "OpenSSL",
					       cipherAlgorithm: "aes-128-cbc",
					       secret: "Beer"
					      });

    var decipherResult = decipher.decipherSync(cipherResult);
    RadJav.Console.println("Decipher Result: " + decipherResult + ", len:" + decipherResult.length);
    

}
catch (error)
{
    RadJav.Console.println(error);
}

try {
    RadJav.Console.println("##################### Test 5 ######################################");
    var cipher = new RadJav.Crypto.Cipher({cryptoLibrary: "OpenSSL",
					   cipherAlgorithm: "aes-128-cbc",
					   secret: "Beer"
					  });

    var str = 'asdfadfadsf';
    var plainText = new ArrayBuffer(str.length);
    var plainTextView = new Uint8Array(plainText);
    for (var i=0; i < str.length; i++)
	plainTextView[i] = str.charCodeAt(i);
    
    var cipherResult = cipher.cipherSync(plainText);
    var cipherData = new Uint8Array(cipherResult);
    RadJav.Console.println("Cipher Algorithm: " + cipher.cipherAlgorithm);
    RadJav.Console.println("Cipher Result: " + hexdump(cipherResult) + hexdump(cipherResult) +
			   ", " + buf2hex(cipherResult) +
			   ", len:" + cipherData.length);


    var decipher = new RadJav.Crypto.Decipher({cryptoLibrary: "OpenSSL",
					       cipherAlgorithm: "aes-128-cbc",
					       secret: "Beer"
					      });

    var decipherResult = decipher.decipherSync(cipherResult);
    RadJav.Console.println("Decipher Result: " + decipherResult + ", len:" + decipherResult.length);
    

}
catch (error)
{
    RadJav.Console.println(error);
}



RadJav.Console.println("##################### Test 6 ######################################");

try {
    var cipher = new RadJav.Crypto.Cipher({cryptoLibrary: "OpenSSL",
					   cipherAlgorithm: "aes-128-cbc",
					   secret: "Beer",
					   outputEncoding: "base64"
					  });

    var cipherResult = cipher.cipherSync('asdfadfadsf');
    RadJav.Console.println("Cipher Algorithm: " + cipher.cipherAlgorithm);
    RadJav.Console.println("Cipher Result: " + cipherResult);

    var cipherResult2 = cipher.cipherSync('asdfadfadsf');
    RadJav.Console.println("Cipher Algorithm: " + cipher.cipherAlgorithm);
    RadJav.Console.println("Cipher Result: " + cipherResult2);

    cipher.cipher('asdfadfadsf').then (function (data)
					{
					    alert("T6 Done!\nCipher Alg: " + cipher.cipherAlgorithm + "\nCipher: " + data);
					});



    var decipher = new RadJav.Crypto.Decipher({cryptoLibrary: "OpenSSL",
					       cipherAlgorithm: "aes-128-cbc",
					       secret: "Beer",
					       inputEncoding: "base64"
					      });

    var decipherResult = decipher.decipherSync(cipherResult);
    RadJav.Console.println("Decipher Result: " + decipherResult);

}
catch (error)
{
    RadJav.Console.println(error);
}


alert("dingdong!");

RadJav.Console.println("##################### Test 7 ######################################");

try {
    var cipher = new RadJav.Crypto.Cipher({cryptoLibrary: "OpenSSL",
					   cipherAlgorithm: "aes-128-cbc",
					   secret: "Beer"
					  });

    var cipherResult = cipher.cipherSync('asdfadfadsf');
    RadJav.Console.println("Cipher Algorithm: " + cipher.cipherAlgorithm);
    RadJav.Console.println("Cipher Result: " + cipherResult);

    var cipherResult2 = cipher.cipherSync('asdfadfadsf');
    RadJav.Console.println("Cipher Algorithm: " + cipher.cipherAlgorithm);
    RadJav.Console.println("Cipher Result: " + cipherResult2);

    cipher.cipher('asdfadfadsf').then (function (data)
					{
					    alert("T7 Done!\nCipher Alg: " + cipher.cipherAlgorithm + "\nCipher: " + buf2hex(data));
					});



    var decipher = new RadJav.Crypto.Decipher({cryptoLibrary: "OpenSSL",
					       cipherAlgorithm: "aes-128-cbc",
					       secret: "Beer",
					       inputEncoding: "binary"
					      });

    var decipherResult = decipher.decipherSync(cipherResult);
    RadJav.Console.println("T7 Decipher Result: " + decipherResult);

}
catch (error)
{
    RadJav.Console.println(error);
}


function buf2hex(buffer) { // buffer is an ArrayBuffer
  return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
}

function pad(n, width, z = '0') {
    return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
}
function hexdump(buf) {
    let view = new Uint8Array(buf);
    let hex = Array.from(view).map(v => this.pad(v.toString(16), 2));
    return `<Buffer ${hex.join(" ")}>`;
}
