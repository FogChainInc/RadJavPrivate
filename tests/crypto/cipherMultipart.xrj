var win = new RadJav.GUI.Window ("win", "Window Example");

// Stupid hack for now. Delete in the future. Should throw errors in HTML5.
win.create ().then (function (win2)
	{
	});

var capabilities = RadJav.Crypto.CipherMultipart.getCapabilities();

if ( (typeof capabilities.cryptoLibs === "object") && (capabilities.cryptoLibs !== null) )
{
    RadJav.Console.println("Has Crypto Implementation: ");
    for (var cryptoLib in capabilities.cryptoLibs)
    {
	RadJav.Console.println(cryptoLib);
    }
}

// Go for OpenSSL
if ( (typeof capabilities.cryptoLibs.OpenSSL === "object") && (capabilities.cryptoLibs.OpenSSL !== null) )
{
    var cryptoLib = capabilities.cryptoLibs.OpenSSL;
    for (var idx in cryptoLib.cipherAlgorithms)
    {
	RadJav.Console.println(cryptoLib.cipherAlgorithms[idx].name + ":\t" + cryptoLib.cipherAlgorithms[idx].description);
    }

}


try
{
    RadJav.Console.println("##################### Test 1 ######################################");
    var cipher = new RadJav.Crypto.CipherMultipart({cryptoLibrary: "OpenSSL",
						    cipherAlgorithm: "blah",
						    outputEncoding: "hex"});

    var cipherResult = cipher.cipherSync('asdfadfadsf');
    RadJav.Console.println("Cipher Algorithm: " + cipher.cipherAlgorithm);
    RadJav.Console.println("Cipher Result: " + cipherResult);
}
catch (error)
{
    RadJav.Console.println(error);
}

try {
    RadJav.Console.println("##################### Test 2 ######################################");
    var cipher = new RadJav.Crypto.CipherMultipart({cryptoLibrary: "OpenSSL",
					   cipherAlgorithm: "aes-128-cbc",
					   outputEncoding: "base64"});

    var cipherResult = cipher.cipherSync('asdfadfadsf');
    RadJav.Console.println("Cipher Algorithm: " + cipher.cipherAlgorithm);
    RadJav.Console.println("Cipher Result: " + cipherResult + ", len: " );
}
catch (error)
{
    RadJav.Console.println(error);
}


try {
    RadJav.Console.println("##################### Test 3 ######################################");
    var cipher = new RadJav.Crypto.CipherMultipart({cryptoLibrary: "OpenSSL",
						    cipherAlgorithm: "aes-128-cbc",
						    secret: "Beer",
						    outputEncoding: "base64"});

    var cipherResult = cipher.updateSync('asd');
    cipherResult += cipher.updateSync('fadfadsf');
    cipherResult += cipher.finalize()
    RadJav.Console.println("Cipher Algorithm: " + cipher.cipherAlgorithm);
    RadJav.Console.println("Cipher Result: " + cipherResult);


    var decipher = new RadJav.Crypto.Decipher({cryptoLibrary: "OpenSSL",
					       cipherAlgorithm: "aes-128-cbc",
					       secret: "Beer",
					       inputEncoding: "base64"
					      });

    var decipherResult = decipher.decipherSync(cipherResult);
    RadJav.Console.println("Decipher Result: " + decipherResult);
}
catch (error)
{
    RadJav.Console.println(error);
}


function getPart() {
    return "aFNMBaeF";
}

function getPart2() {
    return "wCv0e26fypV2WQ==";
}

try {
    RadJav.Console.println("##################### Test 4 ######################################");
    var cipher = new RadJav.Crypto.CipherMultipart({cryptoLibrary: "OpenSSL",
						    cipherAlgorithm: "aes-128-cbc",
						    secret: "Beer",
						    outputEncoding: "base64"});

    var decipher = new RadJav.Crypto.DecipherMultipart({cryptoLibrary: "OpenSSL",
							cipherAlgorithm: "aes-128-cbc",
							secret: "Beer",
							inputEncoding: "base64"
						       });
    var decipher1 = new RadJav.Crypto.Decipher({cryptoLibrary: "OpenSSL",
					       cipherAlgorithm: "aes-128-cbc",
					       secret: "Beer",
					       inputEncoding: "base64"
					      });

    var decipherResult1 = decipher1.decipherSync("aFNMBaeFwCv0e26fypV2WQ==");
    RadJav.Console.println("Decipher1 Result: " + decipherResult1);

    
    var decipherResult = decipher.updateSync("aFNMBaeF");
    decipherResult += decipher.updateSync("wCv0e26fypV2WQ==");
    decipherResult += decipher.finalize();
    RadJav.Console.println("Decipher Result: " + decipherResult);
    
    decipher.reset();
    decipherResult = decipher.updateSync("aFNMBaeF");
    decipherResult += decipher.updateSync("wCv0e26fypV2WQ==");
    decipherResult += decipher.finalize();
    RadJav.Console.println("Decipher Result (2): " + decipherResult);
    
    decipher.reset();
    decipherResult = decipher.updateSync(getPart());
    decipherResult = decipher.updateSync(getPart2());
    decipherResult += decipher.finalize();
    RadJav.Console.println("Decipher Result (3): " + decipherResult);
    
    /*
    decipherResult += decipher.update(cipher.update('fadfadsf'));
    decipherResult += decipher.finalize(cipher.finalize());
    RadJav.Console.println("Cipher Algorithm: " + cipher.cipherAlgorithm);
    //RadJav.Console.println("Cipher Result: " + cipherResult);
    */
    
}
catch (error)
{
    RadJav.Console.println(error);
}

function buf2hex(buffer) { // buffer is an ArrayBuffer
  return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
}

function pad(n, width, z = '0') {
    return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
}
function hexdump(buf) {
    let view = new Uint8Array(buf);
    let hex = Array.from(view).map(v => this.pad(v.toString(16), 2));
    return `<Buffer ${hex.join(" ")}>`;
}
