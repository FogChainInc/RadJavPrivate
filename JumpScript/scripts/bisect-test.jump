/**
 * You should have ts-node installed globally before executing this, probably!
 * Otherwise you'll need to compile this script before you start bisecting!
 */
import cp = require('child_process');
import fs = require('fs');

// Slice off 'node bisect-test.js' from the commandline args
var args = process.argv.slice(2);

function jmpc(jmpcArgs: string, onExit: (exitCode: number) => void) {
    var jmpc = cp.exec('node built/local/jmpc.js ' + jmpcArgs,() => void 0);
    jmpc.on('close', jmpcExitCode => {
        onExit(jmpcExitCode);
    });
}

var jake = cp.exec('jake clean local', () => void 0);
jake.on('close', jakeExitCode => {
    if (jakeExitCode === 0) {
        // See what we're being asked to do
        if (args[1] === 'compiles' || args[1] === '!compiles') {
            jmpc(args[0], jmpcExitCode => {
                if ((jmpcExitCode === 0) === (args[1] === 'compiles')) {
                    console.log('Good');
                    process.exit(0); // Good
                } else {
                    console.log('Bad');
                    process.exit(1); // Bad
                }
            });
        } else if (args[1] === 'emits' || args[1] === '!emits') {
            jmpc(args[0], jmpcExitCode => {
                fs.readFile(args[2], 'utf-8', (err, data) => {
                    var doesContains = data.indexOf(args[3]) >= 0;
                    if (doesContains === (args[1] === 'emits')) {
                        console.log('Good');
                        process.exit(0); // Good
                    } else {
                        console.log('Bad');
                        process.exit(1); // Bad
                    }
                });
            });
        } else {
            console.log('Unknown command line arguments.');
            console.log('Usage (compile errors): git bisect run ts-node scripts\bisect-test.jump "../failure.jump --module amd" !compiles');
            console.log('Usage (emit check): git bisect run ts-node scripts\bisect-test.jump bar.jump emits bar.js "_this = this"');
            // Aborts the 'git bisect run' process
            process.exit(-1);
        }
    } else {
        // Compiler build failed; skip this commit
        console.log('Skip');
        process.exit(125); // bisect skip
    }
});
 